<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PPE Safety Monitoring System | UMPSA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    
    <!-- ========== FAVICON / BROWSER ICONS ========== -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ°Ô∏è</text></svg>">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        :root {
            --primary: #1a73e8;
            --danger: #ea4335;
            --success: #34a853;
            --warning: #fbbc05;
            --dark: #0f172a;
            --dark-secondary: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --umpsa-blue: #0047AB;
            --versafac-green: #006400;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--light);
            min-height: 100vh;
            padding: 15px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        /* ========== HEADER ========== */
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 6px solid var(--warning);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--success), var(--warning));
        }
        
        .institution-section {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 150px;
        }
        
        .institution-name {
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        .institution-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 5px 12px;
            border-radius: 15px;
            text-align: center;
            display: inline-block;
        }
        
        .umpsa-badge {
            background: linear-gradient(135deg, var(--umpsa-blue), #1a73e8);
            color: white;
        }
        
        .versafac-badge {
            background: linear-gradient(135deg, var(--versafac-green), #228B22);
            color: white;
        }
        
        .title-section {
            flex-grow: 1;
            text-align: center;
            padding: 0 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        
        .main-title {
            color: white;
            font-size: 1.6rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 400;
            font-size: 0.9rem;
            margin: 0;
        }
        
        .header-stats-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 150px;
            align-items: flex-end;
        }
        
        .header-stat {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            width: 100%;
            justify-content: center;
            font-size: 0.85rem;
        }
        
        .header-stat i {
            color: var(--warning);
            font-size: 1rem;
        }
        
        .datetime-display {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            font-size: 0.8rem;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            text-align: center;
            width: 100%;
        }
        
        /* ========== CCTV QUICK ACCESS ========== */
        .cctv-quick-access {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .cctv-access-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .cctv-access-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .cctv-access-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .cctv-access-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .cctv-access-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .cctv-access-card:hover {
            transform: translateY(-3px);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .cctv-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .cctv-card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary), #3f51b5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }
        
        .cctv-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
        }
        
        .cctv-card-description {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
        }
        
        .cctv-card-url {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 12px;
            border-radius: 8px;
            font-family: 'Monaco', 'Courier New', monospace;
            word-break: break-all;
        }
        
        /* LIVE STREAM SECTION */
        .live-stream-section {
            background: var(--dark-secondary);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .live-stream-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .live-stream-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stream-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .live-stream-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
        }

        @media (max-width: 1200px) {
            .live-stream-container {
                grid-template-columns: 1fr;
            }
        }

        /* Video Stream */
        .video-container {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 16/9;
            min-height: 300px;
        }

        #liveVideo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 12px;
            background: linear-gradient(180deg, rgba(0,0,0,0.7) 0%, transparent 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .video-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator-stream {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--danger);
            animation: pulse 2s infinite;
        }

        .status-indicator-stream.active {
            background: var(--success);
        }

        .video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px;
            background: linear-gradient(0deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .stream-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .info-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
        }

        .info-card-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            color: var(--primary);
            font-weight: 600;
            font-size: 0.95rem;
        }

        .info-card-content {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.5;
        }

        .cctv-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .detail-label {
            color: var(--gray);
            font-size: 0.8rem;
        }

        .detail-value {
            color: white;
            font-weight: 500;
            font-size: 0.8rem;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: var(--dark-secondary);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
        }
        
        .stat-card.violations {
            border-top: 4px solid var(--danger);
        }
        
        .stat-card.compliance {
            border-top: 4px solid var(--success);
        }
        
        .stat-card.breakdown {
            border-top: 4px solid var(--primary);
        }
        
        .stat-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .stat-icon {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .violations .stat-icon {
            background: rgba(234, 67, 53, 0.15);
            color: var(--danger);
        }
        
        .compliance .stat-icon {
            background: rgba(52, 168, 83, 0.15);
            color: var(--success);
        }
        
        .breakdown .stat-icon {
            background: rgba(26, 115, 232, 0.15);
            color: var(--primary);
        }
        
        .stat-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            margin: 12px 0;
            line-height: 1;
        }
        
        .violations .stat-value {
            color: var(--danger);
        }
        
        .compliance .stat-value {
            color: var(--success);
        }
        
        .breakdown .stat-value {
            color: var(--primary);
        }
        
        .stats-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-detail {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-detail-label {
            font-size: 0.8rem;
            color: var(--gray);
            margin-bottom: 6px;
            font-weight: 500;
        }
        
        .stat-detail-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
        }
        
        .detail-bad {
            color: var(--danger) !important;
        }
        
        .detail-good {
            color: var(--success) !important;
        }
        
        /* Controls */
        .controls {
            background: var(--dark-secondary);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .controls-left {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .controls-right {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 25px;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .datetime {
            color: var(--gray);
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        /* Buttons */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: 'Poppins', sans-serif;
            white-space: nowrap;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #0d62d9;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #2a9c4f;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #d23a2d;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: var(--warning);
            color: #333;
        }
        
        .btn-warning:hover {
            background: #e0ac05;
            transform: translateY(-2px);
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header-container {
                padding: 12px;
                gap: 10px;
            }
            
            .main-title {
                font-size: 1.3rem;
                gap: 8px;
            }
            
            .institution-name {
                font-size: 1.2rem;
            }
            
            .subtitle {
                font-size: 0.8rem;
            }
            
            .cctv-quick-access, .live-stream-section, .stats-grid, .controls, .table-container {
                padding: 15px;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            
            .stat-value {
                font-size: 2rem;
            }
            
            .stat-detail-value {
                font-size: 1.3rem;
            }
            
            .video-container {
                min-height: 250px;
            }
            
            .cctv-access-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .main-title {
                font-size: 1.1rem;
            }
            
            .institution-name {
                font-size: 1rem;
            }
            
            .btn {
                padding: 8px 10px;
                font-size: 0.8rem;
            }
            
            .header-stat, .datetime-display {
                font-size: 0.75rem;
                padding: 6px 10px;
            }
            
            .cctv-access-title, .live-stream-title {
                font-size: 1.1rem;
            }
            
            .video-container {
                min-height: 200px;
            }
            
            .stream-controls {
                justify-content: center;
            }
            
            .stream-controls .btn {
                flex: 1;
                min-width: 120px;
                justify-content: center;
            }
        }
        
        /* Touch-friendly improvements */
        .btn, button {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        .btn:active, button:active {
            transform: scale(0.95);
        }
        
        input, select, textarea {
            font-size: 16px !important; /* Prevents iOS zoom on focus */
        }
        
        /* Long press context menu prevention */
        * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* Allow text selection in specific elements */
        .cctv-card-url, .datetime-cell, .detail-value {
            -webkit-user-select: text;
            user-select: text;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ========== HEADER ========== -->
        <div class="header-container">
            <div class="institution-section">
                <div class="institution-name">
                    <i class="fas fa-university"></i>
                    UMPSA
                </div>
                <span class="institution-badge umpsa-badge">UNIVERSITY</span>
            </div>
            
            <div class="title-section">
                <h1 class="main-title">
                    <i class="fas fa-hard-hat"></i>
                    PPE SAFETY MONITORING SYSTEM
                </h1>
                <p class="subtitle">Industrial Safety Compliance & Monitoring</p>
            </div>
            
            <div class="header-stats-container">
                <div class="institution-name">
                    <i class="fas fa-bolt"></i>
                    VERSAFAC
                </div>
                <span class="institution-badge versafac-badge">SAFETY SOLUTION</span>
                
                <div class="header-stat">
                    <i class="fas fa-shield-alt"></i>
                    <span>SAFETY FIRST</span>
                </div>
                <div class="datetime-display" id="currentDateTimeHeader">
                    Loading...
                </div>
            </div>
        </div>
        
        <!-- ========== CCTV QUICK ACCESS ========== -->
        <div class="cctv-quick-access">
            <div class="cctv-access-header">
                <div class="cctv-access-title">
                    <i class="fas fa-video"></i>
                    QUICK CCTV ACCESS
                </div>
                <div class="cctv-access-buttons">
                    <button class="btn btn-success" onclick="testNgrokConnection()">
                        <i class="fas fa-wifi"></i> Test Connection
                    </button>
                    <button class="btn btn-warning" onclick="copyNgrokUrl()">
                        <i class="fas fa-copy"></i> Copy URL
                    </button>
                </div>
            </div>
            
            <div class="cctv-access-grid">
                <!-- Mobile CCTV Access -->
                <div class="cctv-access-card">
                    <div class="cctv-card-header">
                        <div class="cctv-card-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="cctv-card-title">Mobile CCTV Access</div>
                    </div>
                    <div class="cctv-card-description">
                        Access CCTV stream directly on your mobile device. Optimized for smartphones and tablets.
                    </div>
                    <div class="cctv-card-url" id="mobileNgrokUrl">
                        https://interparental-maggie-relatable.ngrok-free.dev
                    </div>
                    <button class="btn btn-primary" onclick="openMobileCCTV()">
                        <i class="fas fa-external-link-alt"></i> Open in New Tab
                    </button>
                </div>
                
                <!-- Desktop CCTV Access -->
                <div class="cctv-access-card">
                    <div class="cctv-card-header">
                        <div class="cctv-card-icon">
                            <i class="fas fa-desktop"></i>
                        </div>
                        <div class="cctv-card-title">Desktop CCTV Access</div>
                    </div>
                    <div class="cctv-card-description">
                        Full-featured CCTV interface for desktop computers with advanced controls and monitoring.
                    </div>
                    <div class="cctv-card-url" id="desktopNgrokUrl">
                        https://interparental-maggie-relatable.ngrok-free.dev
                    </div>
                    <button class="btn btn-primary" onclick="openDesktopCCTV()">
                        <i class="fas fa-external-link-alt"></i> Open in New Tab
                    </button>
                </div>
                
                <!-- Direct Stream Access -->
                <div class="cctv-access-card">
                    <div class="cctv-card-header">
                        <div class="cctv-card-icon">
                            <i class="fas fa-stream"></i>
                        </div>
                        <div class="cctv-card-title">Direct Video Stream</div>
                    </div>
                    <div class="cctv-card-description">
                        Direct MJPEG video stream URL for integration with other applications or media players.
                    </div>
                    <div class="cctv-card-url" id="streamUrl">
                        https://interparental-maggie-relatable.ngrok-free.dev/video
                    </div>
                    <button class="btn btn-secondary" onclick="openVideoStream()">
                        <i class="fas fa-play-circle"></i> Open Stream
                    </button>
                </div>
            </div>
        </div>
        
        <!-- LIVE STREAM SECTION -->
        <div class="live-stream-section">
            <div class="live-stream-header">
                <div class="live-stream-title">
                    <i class="fas fa-video"></i>
                    LIVE CCTV MONITORING
                </div>
                <div class="stream-controls">
                    <button class="btn btn-success" onclick="startCCTV()" id="startCCTVBtn">
                        <i class="fas fa-play"></i> Start CCTV
                    </button>
                    <button class="btn btn-danger" onclick="stopCCTV()" id="stopCCTVBtn" disabled>
                        <i class="fas fa-stop"></i> Stop CCTV
                    </button>
                    <button class="btn btn-warning" onclick="refreshStream()" id="refreshStreamBtn">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="btn btn-primary" onclick="openMobileCCTV()" id="openCCTVBtn">
                        <i class="fas fa-external-link-alt"></i> Full Screen
                    </button>
                </div>
            </div>
            
            <div class="live-stream-container">
                <!-- Video Stream -->
                <div class="video-container">
                    <img id="liveVideo" src="" alt="Live CCTV Stream">
                    <div class="video-overlay">
                        <div class="video-status">
                            <div class="status-indicator-stream" id="videoStatusIndicator"></div>
                            <span id="videoStatusText">Initializing...</span>
                        </div>
                    </div>
                    <div class="video-controls">
                        <button class="btn btn-secondary btn-sm" onclick="takeSnapshot()">
                            <i class="fas fa-camera"></i> Snapshot
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="toggleFullscreen()">
                            <i class="fas fa-expand"></i> Fullscreen
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="openVideoStream()">
                            <i class="fas fa-stream"></i> Stream Only
                        </button>
                    </div>
                </div>
                
                <!-- Stream Information -->
                <div class="stream-info">
                    <div class="info-card">
                        <div class="info-card-title">
                            <i class="fas fa-info-circle"></i>
                            QUICK START GUIDE
                        </div>
                        <div class="info-card-content">
                            <ol style="margin: 10px 0; padding-left: 20px;">
                                <li>Click "Start CCTV" to begin streaming</li>
                                <li>Use "Full Screen" for best viewing</li>
                                <li>Take snapshots with camera button</li>
                                <li>Refresh if stream lags</li>
                            </ol>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-card-title">
                            <i class="fas fa-chart-bar"></i>
                            CURRENT STATUS
                        </div>
                        <div class="cctv-details">
                            <div class="detail-item">
                                <span class="detail-label">Stream Status:</span>
                                <span class="detail-value" id="streamStatusDetail">OFF</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Frame Rate:</span>
                                <span class="detail-value" id="frameRateInfo">0 FPS</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Connection:</span>
                                <span class="detail-value" id="connectionStatus">Disconnected</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-card-title">
                            <i class="fas fa-link"></i>
                            ACCESS LINKS
                        </div>
                        <div class="cctv-details">
                            <div class="detail-item">
                                <span class="detail-label">Mobile:</span>
                                <button class="btn btn-sm btn-secondary" style="padding: 2px 8px; font-size: 0.7rem;" onclick="openMobileCCTV()">
                                    Open
                                </button>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Desktop:</span>
                                <button class="btn btn-sm btn-secondary" style="padding: 2px 8px; font-size: 0.7rem;" onclick="openDesktopCCTV()">
                                    Open
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card violations">
                <div class="stat-card-header">
                    <div class="stat-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-title">SAFETY VIOLATIONS</div>
                </div>
                <div class="stat-value" id="totalViolations">0</div>
                <div class="stats-details">
                    <div class="stat-detail">
                        <div class="stat-detail-label">Helmet Violations</div>
                        <div class="stat-detail-value detail-bad" id="helmetViolations">0</div>
                    </div>
                    <div class="stat-detail">
                        <div class="stat-detail-label">Glove Violations</div>
                        <div class="stat-detail-value detail-bad" id="gloveViolations">0</div>
                    </div>
                </div>
            </div>
            
            <div class="stat-card compliance">
                <div class="stat-card-header">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-title">FULL PPE COMPLIANCE</div>
                </div>
                <div class="stat-value" id="fullPPE">0</div>
                <div class="stats-details">
                    <div class="stat-detail">
                        <div class="stat-detail-label">Helmet Status OK</div>
                        <div class="stat-detail-value detail-good" id="helmetOK">0</div>
                    </div>
                    <div class="stat-detail">
                        <div class="stat-detail-label">Glove Status OK</div>
                        <div class="stat-detail-value detail-good" id="gloveOK">0</div>
                    </div>
                </div>
            </div>
            
            <div class="stat-card breakdown">
                <div class="stat-card-header">
                    <div class="stat-icon">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <div class="stat-title">SAFETY STATUS BREAKDOWN</div>
                </div>
                <div class="stat-value" id="totalRecords">0</div>
                <div class="stats-details">
                    <div class="stat-detail">
                        <div class="stat-detail-label">With Helmet</div>
                        <div class="stat-detail-value" id="withHelmet">0</div>
                    </div>
                    <div class="stat-detail">
                        <div class="stat-detail-label">Without Helmet</div>
                        <div class="stat-detail-value detail-bad" id="withoutHelmet">0</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Controls -->
        <div class="controls">
            <div class="controls-left">
                <button class="btn btn-primary" onclick="loadData()" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
                <button class="btn btn-secondary" onclick="toggleAutoRefresh()" id="autoRefreshBtn">
                    <i class="fas fa-clock"></i> Auto Refresh: <span id="autoRefreshStatus">OFF</span>
                </button>
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Connected to Safety System</span>
                </div>
            </div>
            <div class="controls-right">
                <div class="datetime">
                    <i class="fas fa-link"></i> CCTV URL: 
                    <button class="btn btn-sm btn-secondary" style="margin-left: 5px; padding: 2px 8px;" onclick="copyNgrokUrl()">
                        Copy
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Connection Status Panel -->
        <div class="live-stream-section">
            <div class="live-stream-header">
                <div class="live-stream-title">
                    <i class="fas fa-network-wired"></i>
                    CONNECTION STATUS
                </div>
            </div>
            
            <div class="live-stream-container">
                <div class="stream-info">
                    <div class="info-card">
                        <div class="info-card-title">
                            <i class="fas fa-wifi"></i>
                            NGROK CONNECTION
                        </div>
                        <div class="cctv-details">
                            <div class="detail-item">
                                <span class="detail-label">Ngrok URL:</span>
                                <span class="detail-value" id="ngrokUrlDisplay">https://interparental-maggie-relatable.ngrok-free.dev</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Status:</span>
                                <span class="detail-value" id="ngrokStatus">Checking...</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Last Check:</span>
                                <span class="detail-value" id="lastCheck">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-card-title">
                            <i class="fas fa-server"></i>
                            FLASK SERVER
                        </div>
                        <div class="cctv-details">
                            <div class="detail-item">
                                <span class="detail-label">Flask URL:</span>
                                <span class="detail-value" id="flaskUrlDisplay">http://localhost:5000</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Status:</span>
                                <span class="detail-value" id="flaskStatus">Checking...</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-card-title">
                            <i class="fas fa-camera"></i>
                            CCTV CAMERA
                        </div>
                        <div class="cctv-details">
                            <div class="detail-item">
                                <span class="detail-label">RTSP Status:</span>
                                <span class="detail-value" id="rtspStatus">Checking...</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Stream:</span>
                                <span class="detail-value" id="streamStatus">Stopped</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="stream-info">
                    <div class="info-card">
                        <div class="info-card-title">
                            <i class="fas fa-mobile-alt"></i>
                            MOBILE ACCESS
                        </div>
                        <div class="info-card-content">
                            <p>To access CCTV on mobile:</p>
                            <ol style="margin: 10px 0; padding-left: 20px;">
                                <li>Open browser on your phone</li>
                                <li>Go to the URL shown above</li>
                                <li>Press "Start CCTV" button</li>
                                <li>Rotate phone for full screen</li>
                            </ol>
                            <button class="btn btn-success" onclick="openMobileCCTV()" style="width: 100%; margin-top: 10px;">
                                <i class="fas fa-external-link-alt"></i> Open Mobile Version
                            </button>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-card-title">
                            <i class="fas fa-desktop"></i>
                            DESKTOP ACCESS
                        </div>
                        <div class="info-card-content">
                            <p>For best desktop experience:</p>
                            <ol style="margin: 10px 0; padding-left: 20px;">
                                <li>Use Chrome/Firefox browser</li>
                                <li>Allow camera permissions</li>
                                <li>Use Full Screen mode</li>
                                <li>Check connection if lagging</li>
                            </ol>
                            <button class="btn btn-primary" onclick="openDesktopCCTV()" style="width: 100%; margin-top: 10px;">
                                <i class="fas fa-external-link-alt"></i> Open Desktop Version
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" style="display: none; position: fixed; bottom: 20px; right: 20px; background: var(--primary); color: white; padding: 15px; border-radius: 10px; z-index: 1000; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
        <span id="toastMessage"></span>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // Configuration
        const NGROK_URL = "https://interparental-maggie-relatable.ngrok-free.dev";
        const FLASK_URL = "http://localhost:5000"; // Default Flask URL
        
        // DOM Elements
        const elements = {
            mobileNgrokUrl: document.getElementById('mobileNgrokUrl'),
            desktopNgrokUrl: document.getElementById('desktopNgrokUrl'),
            streamUrl: document.getElementById('streamUrl'),
            ngrokUrlDisplay: document.getElementById('ngrokUrlDisplay'),
            liveVideo: document.getElementById('liveVideo'),
            videoStatusIndicator: document.getElementById('videoStatusIndicator'),
            videoStatusText: document.getElementById('videoStatusText'),
            startCCTVBtn: document.getElementById('startCCTVBtn'),
            stopCCTVBtn: document.getElementById('stopCCTVBtn'),
            refreshStreamBtn: document.getElementById('refreshStreamBtn'),
            openCCTVBtn: document.getElementById('openCCTVBtn'),
            streamStatusDetail: document.getElementById('streamStatusDetail'),
            frameRateInfo: document.getElementById('frameRateInfo'),
            connectionStatus: document.getElementById('connectionStatus'),
            ngrokStatus: document.getElementById('ngrokStatus'),
            flaskStatus: document.getElementById('flaskStatus'),
            rtspStatus: document.getElementById('rtspStatus'),
            streamStatus: document.getElementById('streamStatus'),
            lastCheck: document.getElementById('lastCheck'),
            currentDateTimeHeader: document.getElementById('currentDateTimeHeader'),
            statusDot: document.getElementById('statusDot'),
            statusText: document.getElementById('statusText'),
            refreshBtn: document.getElementById('refreshBtn'),
            autoRefreshBtn: document.getElementById('autoRefreshBtn'),
            autoRefreshStatus: document.getElementById('autoRefreshStatus'),
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toastMessage')
        };
        
        let autoRefreshInterval = null;
        let autoRefreshEnabled = false;
        let videoStreamInterval = null;
        let isCCTVRunning = false;
        let frameCount = 0;
        let lastFrameTime = 0;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initDateTime();
            updateNgrokUrls();
            checkAllConnections();
            startConnectionMonitor();
        });
        
        // Update all displayed ngrok URLs
        function updateNgrokUrls() {
            const urls = [
                elements.mobileNgrokUrl,
                elements.desktopNgrokUrl,
                elements.streamUrl,
                elements.ngrokUrlDisplay
            ];
            
            urls.forEach(element => {
                if (element) element.textContent = NGROK_URL;
            });
        }
        
        // Initialize date time display
        function initDateTime() {
            function updateDateTime() {
                const now = new Date();
                const options = { 
                    weekday: 'short',
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                };
                elements.currentDateTimeHeader.textContent = now.toLocaleDateString('en-US', options);
            }
            updateDateTime();
            setInterval(updateDateTime, 1000);
        }
        
        // Open Mobile CCTV Interface
        function openMobileCCTV() {
            window.open(NGROK_URL, '_blank');
            showToast('Opening mobile CCTV interface...');
        }
        
        // Open Desktop CCTV Interface
        function openDesktopCCTV() {
            window.open(NGROK_URL + '?desktop=true', '_blank');
            showToast('Opening desktop CCTV interface...');
        }
        
        // Open Direct Video Stream
        function openVideoStream() {
            window.open(NGROK_URL + '/video', '_blank');
            showToast('Opening direct video stream...');
        }
        
        // Copy Ngrok URL to clipboard
        function copyNgrokUrl() {
            navigator.clipboard.writeText(NGROK_URL).then(() => {
                showToast('URL copied to clipboard!');
            }).catch(err => {
                showToast('Failed to copy URL: ' + err);
            });
        }
        
        // Test Ngrok connection
        async function testNgrokConnection() {
            try {
                showToast('Testing Ngrok connection...');
                elements.ngrokStatus.textContent = 'Testing...';
                elements.ngrokStatus.style.color = '#fbbc05';
                
                const response = await fetch(NGROK_URL + '/health', {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                if (response.ok) {
                    elements.ngrokStatus.textContent = 'Connected ‚úì';
                    elements.ngrokStatus.style.color = '#34a853';
                    elements.statusDot.style.background = '#34a853';
                    elements.statusText.textContent = 'Ngrok Connected';
                    showToast('Ngrok connection successful!');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Ngrok connection test failed:', error);
                elements.ngrokStatus.textContent = 'Failed ‚úó';
                elements.ngrokStatus.style.color = '#ea4335';
                showToast('Ngrok connection failed: ' + error.message);
            }
            
            elements.lastCheck.textContent = new Date().toLocaleTimeString();
        }
        
        // Check all connections
        async function checkAllConnections() {
            await testNgrokConnection();
            await testFlaskConnection();
        }
        
        // Test Flask connection
        async function testFlaskConnection() {
            try {
                elements.flaskStatus.textContent = 'Testing...';
                elements.flaskStatus.style.color = '#fbbc05';
                
                const response = await fetch(FLASK_URL + '/status', {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    elements.flaskStatus.textContent = 'Connected ‚úì';
                    elements.flaskStatus.style.color = '#34a853';
                    elements.flaskUrlDisplay.textContent = FLASK_URL;
                    isCCTVRunning = data.cctv_running || false;
                    updateCCTVButtons();
                    elements.rtspStatus.textContent = data.cctv_status || 'Unknown';
                    elements.streamStatus.textContent = isCCTVRunning ? 'Running' : 'Stopped';
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Flask connection test failed:', error);
                elements.flaskStatus.textContent = 'Failed ‚úó';
                elements.flaskStatus.style.color = '#ea4335';
                elements.streamStatus.textContent = 'Offline';
            }
        }
        
        // Start connection monitor
        function startConnectionMonitor() {
            // Check connections every 30 seconds
            setInterval(checkAllConnections, 30000);
        }
        
        // Update CCTV buttons
        function updateCCTVButtons() {
            if (isCCTVRunning) {
                elements.startCCTVBtn.disabled = true;
                elements.stopCCTVBtn.disabled = false;
                elements.streamStatusDetail.textContent = 'RUNNING';
                elements.streamStatusDetail.style.color = '#34a853';
                elements.connectionStatus.textContent = 'Connected';
                elements.connectionStatus.style.color = '#34a853';
                startVideoStream();
            } else {
                elements.startCCTVBtn.disabled = false;
                elements.stopCCTVBtn.disabled = true;
                elements.streamStatusDetail.textContent = 'STOPPED';
                elements.streamStatusDetail.style.color = '#ea4335';
                elements.connectionStatus.textContent = 'Disconnected';
                elements.connectionStatus.style.color = '#ea4335';
                stopVideoStream();
            }
        }
        
        // Start CCTV stream
        async function startCCTV() {
            try {
                showToast('Starting CCTV stream...');
                elements.videoStatusText.textContent = 'Starting...';
                elements.videoStatusIndicator.style.background = '#fbbc05';
                
                const response = await fetch(FLASK_URL + '/cctv_control', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ command: 'on' }),
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'ok' && data.running === true) {
                        isCCTVRunning = true;
                        updateCCTVButtons();
                        elements.videoStatusText.textContent = 'Live Stream Active';
                        elements.videoStatusIndicator.style.background = '#34a853';
                        elements.videoStatusIndicator.classList.add('active');
                        showToast('CCTV stream started successfully!');
                        return;
                    }
                }
                throw new Error('Invalid response');
            } catch (error) {
                console.error('Error starting CCTV:', error);
                elements.videoStatusText.textContent = 'Failed to start';
                elements.videoStatusIndicator.style.background = '#ea4335';
                showToast('Failed to start CCTV: ' + error.message);
            }
        }
        
        // Stop CCTV stream
        async function stopCCTV() {
            try {
                showToast('Stopping CCTV stream...');
                elements.videoStatusText.textContent = 'Stopping...';
                elements.videoStatusIndicator.style.background = '#fbbc05';
                
                const response = await fetch(FLASK_URL + '/cctv_control', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ command: 'off' }),
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'ok' && data.running === false) {
                        isCCTVRunning = false;
                        updateCCTVButtons();
                        elements.videoStatusText.textContent = 'Stream Stopped';
                        elements.videoStatusIndicator.style.background = '#ea4335';
                        elements.videoStatusIndicator.classList.remove('active');
                        showToast('CCTV stream stopped successfully!');
                        return;
                    }
                }
                throw new Error('Invalid response');
            } catch (error) {
                console.error('Error stopping CCTV:', error);
                elements.videoStatusText.textContent = 'Failed to stop';
                elements.videoStatusIndicator.style.background = '#ea4335';
                showToast('Failed to stop CCTV: ' + error.message);
            }
        }
        
        // Start video stream
        function startVideoStream() {
            if (videoStreamInterval) {
                clearInterval(videoStreamInterval);
            }
            
            frameCount = 0;
            lastFrameTime = Date.now();
            
            const videoSrc = NGROK_URL + '/video?t=' + Date.now();
            elements.liveVideo.src = videoSrc;
            elements.liveVideo.style.display = 'block';
            
            // Start frame rate calculation
            videoStreamInterval = setInterval(calculateFrameRate, 1000);
            
            // Handle stream errors
            elements.liveVideo.onerror = function() {
                console.warn('Stream error, retrying...');
                elements.videoStatusText.textContent = 'Stream Error - Retrying...';
                setTimeout(() => {
                    if (isCCTVRunning) {
                        const newTimestamp = Date.now();
                        elements.liveVideo.src = NGROK_URL + '/video?t=' + newTimestamp;
                    }
                }, 2000);
            };
            
            // Handle successful load
            elements.liveVideo.onload = function() {
                frameCount++;
                elements.videoStatusText.textContent = 'Live Stream Active';
            };
        }
        
        // Stop video stream
        function stopVideoStream() {
            if (videoStreamInterval) {
                clearInterval(videoStreamInterval);
                videoStreamInterval = null;
            }
            
            elements.liveVideo.src = '';
            elements.liveVideo.style.display = 'none';
            elements.frameRateInfo.textContent = '0 FPS';
        }
        
        // Refresh stream
        function refreshStream() {
            if (isCCTVRunning) {
                const timestamp = Date.now();
                elements.liveVideo.src = NGROK_URL + '/video?t=' + timestamp;
                showToast('Stream refreshed!');
            } else {
                showToast('Please start CCTV first!');
            }
        }
        
        // Calculate frame rate
        function calculateFrameRate() {
            const currentTime = Date.now();
            const elapsed = (currentTime - lastFrameTime) / 1000;
            const fps = elapsed > 0 ? Math.round(frameCount / elapsed) : 0;
            
            elements.frameRateInfo.textContent = `${fps} FPS`;
            
            frameCount = 0;
            lastFrameTime = currentTime;
        }
        
        // Take snapshot
        function takeSnapshot() {
            if (!isCCTVRunning || !elements.liveVideo.src) {
                showToast('Please start CCTV first!');
                return;
            }
            
            try {
                const canvas = document.createElement('canvas');
                const video = elements.liveVideo;
                const context = canvas.getContext('2d');
                
                canvas.width = video.videoWidth || 1280;
                canvas.height = video.videoHeight || 720;
                
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                link.download = `ppe-snapshot-${timestamp}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                showToast('Snapshot saved!');
            } catch (error) {
                showToast('Error taking snapshot: ' + error.message);
            }
        }
        
        // Toggle fullscreen
        function toggleFullscreen() {
            const videoContainer = document.querySelector('.video-container');
            
            if (!document.fullscreenElement) {
                if (videoContainer.requestFullscreen) {
                    videoContainer.requestFullscreen();
                } else if (videoContainer.webkitRequestFullscreen) {
                    videoContainer.webkitRequestFullscreen();
                } else if (videoContainer.mozRequestFullScreen) {
                    videoContainer.mozRequestFullScreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                }
            }
        }
        
        // Show toast notification
        function showToast(message) {
            elements.toastMessage.textContent = message;
            elements.toast.style.display = 'block';
            
            setTimeout(() => {
                elements.toast.style.display = 'none';
            }, 3000);
        }
        
        // Toggle auto refresh
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            
            if (autoRefreshEnabled) {
                startAutoRefresh(30000);
                elements.autoRefreshStatus.textContent = 'ON';
                elements.autoRefreshBtn.innerHTML = '<i class="fas fa-clock"></i> Auto Refresh: ON';
                elements.autoRefreshBtn.style.background = 'rgba(52, 168, 83, 0.2)';
                showToast('Auto refresh enabled (30 seconds)');
            } else {
                stopAutoRefresh();
                elements.autoRefreshStatus.textContent = 'OFF';
                elements.autoRefreshBtn.innerHTML = '<i class="fas fa-clock"></i> Auto Refresh: OFF';
                elements.autoRefreshBtn.style.background = '';
                showToast('Auto refresh disabled');
            }
        }
        
        // Start auto refresh
        function startAutoRefresh(interval) {
            stopAutoRefresh();
            autoRefreshInterval = setInterval(() => {
                checkAllConnections();
                if (isCCTVRunning) {
                    refreshStream();
                }
            }, interval);
        }
        
        // Stop auto refresh
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        // Load data (placeholder function)
        function loadData() {
            showToast('Refreshing safety data...');
            // Implement your data loading logic here
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // F5 to refresh
            if (event.key === 'F5') {
                event.preventDefault();
                refreshStream();
            }
            // Space to toggle CCTV
            if (event.key === ' ') {
                event.preventDefault();
                if (isCCTVRunning) {
                    stopCCTV();
                } else {
                    startCCTV();
                }
            }
            // F for fullscreen
            if (event.key === 'f' || event.key === 'F') {
                event.preventDefault();
                toggleFullscreen();
            }
        });
        
        // Touch gesture support for mobile
        let touchStartY = 0;
        let touchEndY = 0;
        
        document.addEventListener('touchstart', function(event) {
            touchStartY = event.changedTouches[0].screenY;
        });
        
        document.addEventListener('touchend', function(event) {
            touchEndY = event.changedTouches[0].screenY;
            handleSwipe();
        });
        
        function handleSwipe() {
            const swipeDistance = touchStartY - touchEndY;
            
            // Swipe down to refresh
            if (swipeDistance < -100) {
                refreshStream();
                showToast('Refreshed!');
            }
        }
    </script>
</body>
</html>
