<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPE Safety Monitoring Dashboard</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #17a2b8;
        }
        
        body {
            background-color: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 20px;
        }
        
        .navbar-custom {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .card {
            border-radius: 10px;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            transition: transform 0.3s ease;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        
        .card-header {
            background-color: rgba(44, 62, 80, 0.95);
            color: white;
            font-weight: 600;
            border-bottom: none;
            padding: 15px 20px;
        }
        
        .stat-card {
            border-left: 5px solid;
            padding: 20px;
            height: 100%;
        }
        
        .stat-1 { border-left-color: var(--secondary-color); }
        .stat-2 { border-left-color: var(--success-color); }
        .stat-3 { border-left-color: var(--warning-color); }
        .stat-4 { border-left-color: var(--danger-color); }
        
        .stat-number {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--primary-color);
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.85rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-pill {
            border-radius: 50px;
            padding: 5px 12px;
            font-weight: 500;
        }
        
        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #e74c3c;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }
        
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            border-radius: 8px;
            background: white;
        }
        
        .table th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            color: var(--primary-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .violation-row {
            background-color: rgba(231, 76, 60, 0.05) !important;
            border-left: 4px solid var(--danger-color);
        }
        
        .compliance-row {
            background-color: rgba(39, 174, 96, 0.05) !important;
            border-left: 4px solid var(--success-color);
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .dot-success { background-color: var(--success-color); }
        .dot-danger { background-color: var(--danger-color); }
        .dot-warning { background-color: var(--warning-color); }
        .dot-info { background-color: var(--info-color); }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .time-filter {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .image-preview {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .image-preview:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .refresh-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .refresh-btn:hover {
            background-color: #2980b9;
            transform: rotate(90deg);
        }
        
        .export-btn {
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .export-btn:hover {
            background-color: #219653;
        }
        
        @media (max-width: 768px) {
            .stat-number {
                font-size: 1.8rem;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .table-container {
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-hard-hat me-2"></i>PPE Safety Monitoring
            </a>
            <div class="d-flex align-items-center">
                <span class="live-indicator"></span>
                <span class="text-white me-3" id="lastUpdate">Loading...</span>
                <button class="refresh-btn" onclick="loadDashboardData()" title="Refresh Data">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4 px-3 px-md-4">
        <!-- System Status Banner -->
        <div class="alert alert-info d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-server me-2"></i>
                <strong>System Status:</strong> 
                <span id="systemStatusText" class="ms-2">Checking...</span>
            </div>
            <div class="small">
                <i class="fas fa-clock me-1"></i>
                <span id="currentTime">--:--:--</span>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row" id="statsRow">
            <!-- Cards will be populated by JavaScript -->
        </div>

        <!-- Charts Row -->
        <div class="row mt-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>PPE Compliance Overview</span>
                        <div class="small">
                            <span class="badge bg-success me-2">Helmet</span>
                            <span class="badge bg-info">Glove</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="complianceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Violations Analysis</span>
                        <small class="text-white">Today's Data</small>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="violationsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Detections -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Recent Detections</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary me-2" onclick="toggleViolationsOnly()">
                                <i class="fas fa-filter"></i> Show Violations Only
                            </button>
                            <button class="export-btn btn-sm" onclick="exportData()">
                                <i class="fas fa-download me-1"></i> Export
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-container p-3">
                            <table class="table table-hover mb-0" id="detectionsTable">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Helmet Status</th>
                                        <th>Glove Status</th>
                                        <th>Image</th>
                                        <th>Type</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody id="detectionsBody">
                                    <tr id="loadingRow">
                                        <td colspan="6" class="text-center py-5">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="mt-3 text-muted">Loading detection data...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer d-flex justify-content-between align-items-center">
                        <div class="text-muted">
                            Showing <span id="showingCount">0</span> of <span id="totalCount">0</span> records
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" onclick="prevPage()" id="prevBtn" disabled>
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span class="px-3">Page <span id="currentPage">1</span></span>
                            <button class="btn btn-sm btn-outline-primary" onclick="nextPage()" id="nextBtn" disabled>
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Information -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">System Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="systemInfo">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-6">
                                <button class="btn btn-outline-primary w-100" onclick="testAPI()">
                                    <i class="fas fa-bolt me-2"></i>Test API
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-success w-100" onclick="addTestRecord()">
                                    <i class="fas fa-plus me-2"></i>Test Record
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-info w-100" onclick="loadDashboardData()">
                                    <i class="fas fa-sync me-2"></i>Refresh All
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-danger w-100" onclick="clearFilters()">
                                    <i class="fas fa-times me-2"></i>Clear Filters
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detection Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="" class="img-fluid rounded" alt="Detection Image">
                    <div class="mt-3">
                        <p class="mb-1" id="imageTimestamp"></p>
                        <p class="text-muted small" id="imageStatus"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap & jQuery -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
        // ================= CONFIGURATION =================
        const CONFIG = {
            // Replace with your Google Apps Script Web App URL
            API_URL: 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec',
            
            // For testing - use mock data if API fails
            USE_MOCK_DATA: true,
            
            // Refresh interval in milliseconds (30 seconds)
            REFRESH_INTERVAL: 30000,
            
            // Items per page for table
            ITEMS_PER_PAGE: 10
        };

        // ================= GLOBAL VARIABLES =================
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        let showViolationsOnly = false;
        let complianceChart = null;
        let violationsChart = null;

        // ================= INITIALIZATION =================
        $(document).ready(function() {
            console.log('Dashboard initialized');
            
            // Load initial data
            loadDashboardData();
            
            // Set up auto-refresh
            setInterval(loadDashboardData, CONFIG.REFRESH_INTERVAL);
            
            // Update clock every second
            setInterval(updateClock, 1000);
            updateClock();
            
            // Check for URL parameters
            checkUrlParams();
        });

        // ================= MAIN DATA LOADING =================
        function loadDashboardData() {
            showLoading(true);
            updateLastUpdateTime();
            
            // Load dashboard data from Google Apps Script
            $.ajax({
                url: CONFIG.API_URL + '?action=dashboard',
                method: 'GET',
                dataType: 'json',
                timeout: 10000,
                success: function(response) {
                    console.log('Dashboard data loaded:', response);
                    
                    if (response.success) {
                        updateSystemStatus(response);
                        loadStatistics();
                        loadRecentData();
                    } else {
                        showError('Failed to load dashboard data');
                        if (CONFIG.USE_MOCK_DATA) {
                            loadMockData();
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('API Error:', error);
                    showError('Connection error: ' + error);
                    
                    if (CONFIG.USE_MOCK_DATA) {
                        loadMockData();
                    }
                }
            });
        }

        function loadStatistics() {
            $.ajax({
                url: CONFIG.API_URL + '?action=getStats',
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        updateStatistics(response.stats);
                    }
                },
                error: function() {
                    // Silently fail - we'll try again next refresh
                }
            });
        }

        function loadRecentData() {
            $.ajax({
                url: CONFIG.API_URL + '?action=getRecent&limit=50',
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        processData(response.data);
                        updateTable();
                        updateCharts();
                    }
                },
                error: function() {
                    // Silently fail
                },
                complete: function() {
                    showLoading(false);
                }
            });
        }

        // ================= DATA PROCESSING =================
        function processData(data) {
            allData = data.map(item => {
                const timestamp = new Date(item.timestamp || item.datetime);
                const hasHelmet = item.helmetStatus === 'helmet';
                const hasGlove = item.gloveStatus === 'glove';
                const isCompliant = hasHelmet && hasGlove;
                
                return {
                    id: item.id || Date.now() + Math.random(),
                    timestamp: timestamp,
                    dateStr: timestamp.toLocaleDateString(),
                    timeStr: timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    hasHelmet: hasHelmet,
                    hasGlove: hasGlove,
                    helmetStatus: item.helmetStatus || 'unknown',
                    gloveStatus: item.gloveStatus || 'unknown',
                    imageUrl: item.imageUrl || '',
                    logType: item.logType || 'unknown',
                    isCompliant: isCompliant,
                    relativeTime: item.formattedTime || formatRelativeTime(timestamp)
                };
            });
            
            // Sort by timestamp (newest first)
            allData.sort((a, b) => b.timestamp - a.timestamp);
            
            // Apply filters
            applyFilters();
        }

        function applyFilters() {
            filteredData = showViolationsOnly 
                ? allData.filter(item => !item.isCompliant)
                : allData;
            
            currentPage = 1; // Reset to first page
        }

        // ================= UI UPDATES =================
        function updateSystemStatus(data) {
            $('#systemStatusText').html(`
                <span class="badge bg-success">${data.systemStatus}</span>
                <span class="ms-2">${data.serverConnection}</span>
            `);
            
            // Update system info
            if (data.systemInfo) {
                $('#systemInfo').html(`
                    <div class="col-md-6 mb-3">
                        <strong>Server IP:</strong><br>
                        <code>${data.systemInfo.serverIP}</code>
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>RTSP Port:</strong><br>
                        ${data.systemInfo.rtspPort}
                    </div>
                    <div class="col-md-12">
                        <strong>Stream URL:</strong><br>
                        <small>${data.systemInfo.streamUrl}</small>
                    </div>
                `);
            }
        }

        function updateStatistics(stats) {
            if (!stats) return;
            
            $('#statsRow').html(`
                <div class="col-md-3">
                    <div class="card stat-card stat-1">
                        <div class="stat-number">${stats.total || 0}</div>
                        <div class="stat-label">Total Detections</div>
                        <div class="mt-2">
                            <small class="text-muted">${stats.todayRecords || 0} today</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card stat-2">
                        <div class="stat-number">${stats.compliance?.overall || 0}%</div>
                        <div class="stat-label">Overall Compliance</div>
                        <div class="mt-2">
                            <small class="text-muted">${stats.fullPPE || 0} full PPE</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card stat-3">
                        <div class="stat-number">${stats.compliance?.helmet || 0}%</div>
                        <div class="stat-label">Helmet Compliance</div>
                        <div class="mt-2">
                            <small class="text-muted">${stats.helmetOK || 0} OK / ${stats.helmetViolations || 0} violations</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card stat-4">
                        <div class="stat-number">${stats.compliance?.glove || 0}%</div>
                        <div class="stat-label">Glove Compliance</div>
                        <div class="mt-2">
                            <small class="text-muted">${stats.gloveOK || 0} OK / ${stats.gloveViolations || 0} violations</small>
                        </div>
                    </div>
                </div>
            `);
        }

        function updateTable() {
            const tableBody = $('#detectionsBody');
            const totalRecords = filteredData.length;
            
            if (totalRecords === 0) {
                tableBody.html(`
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <i class="fas fa-inbox fa-2x text-muted mb-3"></i>
                            <p class="text-muted">No detection records found</p>
                        </td>
                    </tr>
                `);
                updatePagination(0);
                return;
            }
            
            // Calculate pagination
            const totalPages = Math.ceil(totalRecords / CONFIG.ITEMS_PER_PAGE);
            const startIndex = (currentPage - 1) * CONFIG.ITEMS_PER_PAGE;
            const endIndex = Math.min(startIndex + CONFIG.ITEMS_PER_PAGE, totalRecords);
            const pageData = filteredData.slice(startIndex, endIndex);
            
            // Build table rows
            let tableHTML = '';
            
            pageData.forEach(item => {
                const rowClass = item.isCompliant ? 'compliance-row' : 'violation-row';
                
                const helmetBadge = item.hasHelmet ? 
                    '<span class="badge bg-success">Helmet</span>' : 
                    '<span class="badge bg-danger">No Helmet</span>';
                    
                const gloveBadge = item.hasGlove ? 
                    '<span class="badge bg-success">Glove</span>' : 
                    '<span class="badge bg-danger">No Glove</span>';
                
                const imageCell = item.imageUrl ? 
                    `<td>
                        <img src="${item.imageUrl}" 
                             alt="Detection" 
                             class="image-preview" 
                             onclick="viewImage('${item.imageUrl}', '${item.dateStr} ${item.timeStr}')"
                             onerror="this.style.display='none'">
                    </td>` : 
                    `<td class="text-muted">No image</td>`;
                
                const logTypeBadge = item.logType === 'violation' ? 
                    '<span class="badge bg-danger">Violation</span>' : 
                    '<span class="badge bg-secondary">' + item.logType + '</span>';
                
                tableHTML += `
                    <tr class="${rowClass}">
                        <td>
                            <div class="fw-bold">${item.dateStr}</div>
                            <div class="text-muted small">${item.timeStr}</div>
                        </td>
                        <td>${helmetBadge}</td>
                        <td>${gloveBadge}</td>
                        ${imageCell}
                        <td>${logTypeBadge}</td>
                        <td>
                            <small class="text-muted">${item.relativeTime}</small>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.html(tableHTML);
            updatePagination(totalRecords, startIndex, endIndex, totalPages);
        }

        function updatePagination(totalRecords, startIndex = 0, endIndex = 0, totalPages = 0) {
            $('#showingCount').text(totalRecords > 0 ? `${startIndex + 1}-${endIndex}` : '0');
            $('#totalCount').text(totalRecords);
            $('#currentPage').text(currentPage);
            
            $('#prevBtn').prop('disabled', currentPage <= 1);
            $('#nextBtn').prop('disabled', currentPage >= totalPages);
        }

        function updateCharts() {
            updateComplianceChart();
            updateViolationsChart();
        }

        function updateComplianceChart() {
            const ctx = document.getElementById('complianceChart').getContext('2d');
            
            // Destroy existing chart
            if (complianceChart) {
                complianceChart.destroy();
            }
            
            if (allData.length === 0) {
                renderNoDataChart(ctx, 'complianceChart', 'No data available');
                return;
            }
            
            const stats = calculateChartData();
            
            complianceChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Full PPE', 'Helmet Only', 'Glove Only', 'No PPE'],
                    datasets: [{
                        data: [
                            stats.fullPPE,
                            stats.helmetOnly,
                            stats.gloveOnly,
                            stats.noPPE
                        ],
                        backgroundColor: [
                            '#27ae60', // Green for full PPE
                            '#3498db', // Blue for helmet only
                            '#f39c12', // Orange for glove only
                            '#e74c3c'  // Red for no PPE
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = allData.length;
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateViolationsChart() {
            const ctx = document.getElementById('violationsChart').getContext('2d');
            
            // Destroy existing chart
            if (violationsChart) {
                violationsChart.destroy();
            }
            
            if (allData.length === 0) {
                renderNoDataChart(ctx, 'violationsChart', 'No data available');
                return;
            }
            
            // Get today's violations by hour
            const today = new Date().toDateString();
            const todayData = allData.filter(item => 
                item.timestamp.toDateString() === today && !item.isCompliant
            );
            
            // Group by hour
            const hourlyViolations = {};
            for (let i = 0; i < 24; i++) {
                hourlyViolations[i] = 0;
            }
            
            todayData.forEach(item => {
                const hour = item.timestamp.getHours();
                hourlyViolations[hour] = (hourlyViolations[hour] || 0) + 1;
            });
            
            const hours = Array.from({length: 24}, (_, i) => `${i}:00`);
            const violationCounts = hours.map((_, hour) => hourlyViolations[hour] || 0);
            
            violationsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Violations',
                        data: violationCounts,
                        backgroundColor: 'rgba(231, 76, 60, 0.7)',
                        borderColor: 'rgba(231, 76, 60, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Violations'
                            },
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Hour of Day'
                            },
                            ticks: {
                                maxTicksLimit: 12
                            }
                        }
                    }
                }
            });
        }

        function renderNoDataChart(ctx, chartId, message) {
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['No Data'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['#f8f9fa']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                },
                plugins: [{
                    beforeDraw: function(chart) {
                        const width = chart.width;
                        const height = chart.height;
                        const ctx = chart.ctx;
                        
                        ctx.restore();
                        ctx.font = "14px 'Segoe UI'";
                        ctx.textBaseline = "middle";
                        ctx.fillStyle = "#6c757d";
                        
                        const text = message;
                        const textX = Math.round((width - ctx.measureText(text).width) / 2);
                        const textY = height / 2;
                        
                        ctx.fillText(text, textX, textY);
                        ctx.save();
                    }
                }]
            });
        }

        // ================= HELPER FUNCTIONS =================
        function calculateChartData() {
            const stats = {
                fullPPE: 0,
                helmetOnly: 0,
                gloveOnly: 0,
                noPPE: 0
            };
            
            allData.forEach(item => {
                if (item.hasHelmet && item.hasGlove) {
                    stats.fullPPE++;
                } else if (item.hasHelmet && !item.hasGlove) {
                    stats.helmetOnly++;
                } else if (!item.hasHelmet && item.hasGlove) {
                    stats.gloveOnly++;
                } else {
                    stats.noPPE++;
                }
            });
            
            return stats;
        }

        function formatRelativeTime(date) {
            if (!date) return 'Unknown';
            
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return date.toLocaleDateString();
        }

        function viewImage(url, timestamp) {
            $('#modalImage').attr('src', url);
            $('#imageTimestamp').text(timestamp || '');
            $('#imageStatus').html(`<a href="${url}" target="_blank">Open in new tab</a>`);
            
            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            modal.show();
        }

        function toggleViolationsOnly() {
            showViolationsOnly = !showViolationsOnly;
            applyFilters();
            updateTable();
            
            const btn = event.target.closest('button');
            if (showViolationsOnly) {
                btn.innerHTML = '<i class="fas fa-filter"></i> Show All';
                btn.classList.add('btn-primary');
                btn.classList.remove('btn-outline-secondary');
            } else {
                btn.innerHTML = '<i class="fas fa-filter"></i> Show Violations Only';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-secondary');
            }
        }

        function clearFilters() {
            showViolationsOnly = false;
            const filterBtn = document.querySelector('[onclick="toggleViolationsOnly()"]');
            if (filterBtn) {
                filterBtn.innerHTML = '<i class="fas fa-filter"></i> Show Violations Only';
                filterBtn.classList.remove('btn-primary');
                filterBtn.classList.add('btn-outline-secondary');
            }
            applyFilters();
            updateTable();
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                updateTable();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredData.length / CONFIG.ITEMS_PER_PAGE);
            if (currentPage < totalPages) {
                currentPage++;
                updateTable();
            }
        }

        function exportData() {
            if (allData.length === 0) {
                alert('No data to export!');
                return;
            }
            
            // Create CSV content
            const headers = ['Timestamp', 'Date', 'Time', 'Helmet', 'Gloves', 'Status', 'Image URL'];
            const csvRows = [];
            
            csvRows.push(headers.join(','));
            
            allData.forEach(item => {
                const row = [
                    `"${item.timestamp.toISOString()}"`,
                    `"${item.dateStr}"`,
                    `"${item.timeStr}"`,
                    item.hasHelmet ? 'YES' : 'NO',
                    item.hasGlove ? 'YES' : 'NO',
                    item.isCompliant ? 'COMPLIANT' : 'VIOLATION',
                    `"${item.imageUrl}"`
                ];
                csvRows.push(row.join(','));
            });
            
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            const timestamp = new Date().toISOString().split('T')[0];
            link.setAttribute('href', url);
            link.setAttribute('download', `ppe_detections_${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Data exported successfully!', 'success');
        }

        function updateLastUpdateTime() {
            const now = new Date();
            $('#lastUpdate').text(now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
        }

        function updateClock() {
            const now = new Date();
            $('#currentTime').text(now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'}));
        }

        function showLoading(show) {
            const loadingRow = $('#loadingRow');
            if (show) {
                loadingRow.show();
            } else {
                loadingRow.hide();
            }
        }

        function showError(message) {
            $('#systemStatusText').html(`
                <span class="badge bg-danger">ERROR</span>
                <span class="ms-2 text-danger">${message}</span>
            `);
            showNotification(message, 'danger');
        }

        function showNotification(message, type = 'info') {
            // Remove existing notifications
            $('.alert-notification').remove();
            
            const notification = $(`
                <div class="alert alert-${type} alert-notification alert-dismissible fade show position-fixed"
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
            
            $('body').append(notification);
            
            setTimeout(() => {
                notification.alert('close');
            }, 5000);
        }

        // ================= TEST FUNCTIONS =================
        function testAPI() {
            $.ajax({
                url: CONFIG.API_URL + '?action=test',
                method: 'GET',
                success: function(response) {
                    alert(`API Test Successful!\n\nVersion: ${response.version}\nMessage: ${response.message}`);
                },
                error: function() {
                    alert('API Test Failed - Check console for details');
                }
            });
        }

        function addTestRecord() {
            const testData = {
                action: 'log_ppe',
                timestamp: new Date().toISOString(),
                helmet_status: Math.random() > 0.5 ? 'helmet' : 'no_helmet',
                glove_status: Math.random() > 0.5 ? 'glove' : 'no_glove',
                has_image: 'false',
                log_type: 'test'
            };
            
            $.ajax({
                url: CONFIG.API_URL,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(testData),
                success: function(response) {
                    if (response.success) {
                        showNotification('Test record added successfully!', 'success');
                        setTimeout(loadDashboardData, 1000);
                    } else {
                        showNotification('Failed to add record: ' + response.error, 'danger');
                    }
                },
                error: function() {
                    showNotification('Failed to connect to API', 'danger');
                }
            });
        }

        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('test') === 'true') {
                testAPI();
            }
        }

        // ================= MOCK DATA FOR TESTING =================
        function loadMockData() {
            console.log('Loading mock data for demonstration...');
            
            const mockStats = {
                total: 125,
                helmetOK: 95,
                helmetViolations: 30,
                gloveOK: 105,
                gloveViolations: 20,
                fullPPE: 85,
                totalViolations: 50,
                todayRecords: 15,
                violationsToday: 5,
                compliance: {
                    helmet: 76,
                    glove: 84,
                    overall: 68
                }
            };
            
            const mockData = [];
            const now = new Date();
            
            // Generate mock data
            for (let i = 0; i < 50; i++) {
                const timestamp = new Date(now.getTime() - Math.random() * 7 * 24 * 60 * 60 * 1000);
                const hasHelmet = Math.random() > 0.3;
                const hasGlove = Math.random() > 0.2;
                const isCompliant = hasHelmet && hasGlove;
                
                mockData.push({
                    id: i,
                    timestamp: timestamp,
                    dateStr: timestamp.toLocaleDateString(),
                    timeStr: timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    hasHelmet: hasHelmet,
                    hasGlove: hasGlove,
                    helmetStatus: hasHelmet ? 'helmet' : 'no_helmet',
                    gloveStatus: hasGlove ? 'glove' : 'no_glove',
                    imageUrl: Math.random() > 0.7 ? 'https://via.placeholder.com/300x200/4CAF50/FFFFFF?text=PPE+Detection' : '',
                    logType: isCompliant ? 'normal' : 'violation',
                    isCompliant: isCompliant,
                    relativeTime: formatRelativeTime(timestamp)
                });
            }
            
            // Update UI with mock data
            updateSystemStatus({
                systemStatus: 'READY',
                serverConnection: 'Connected (Mock Data)',
                systemInfo: {
                    serverIP: '192.168.110.50',
                    rtspPort: '554',
                    streamUrl: '/video',
                    model: 'YOLO v6'
                }
            });
            
            updateStatistics(mockStats);
            processData(mockData);
            updateTable();
            updateCharts();
            showLoading(false);
        }
    </script>
</body>
</html>
